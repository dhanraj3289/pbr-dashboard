<!DOCTYPE html>
<html>
<head>
  <title>Live Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>

</head>
<body>
  <h2>Real-Time Sensor Chart (Temperature & pH)</h2>

  <!-- Time Filter Dropdown -->
  <label for="timeFilter">Time Range:</label>
  <select id="timeFilter">
    <option value="5m">Last 5 Minutes</option>
    <option value="1h" selected>Last 1 Hour</option>
    <option value="1d">Last 1 Day</option>
    <option value="1M">Last 1 Month</option>
  </select>

<h2>Temperature Chart (°C)</h2>
<canvas id="tempChart" width="900" height="300"></canvas>

<h2>pH Chart</h2>
<canvas id="phChart" width="900" height="300"></canvas>

<h2>EC Chart</h2>
<canvas id="ecChart" width="900" height="300"></canvas>

<h2>PAR Chart</h2>
<canvas id="parChart" width="900" height="300"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA-GDgNBC4wVbX7fz4oZlrHTDvww3PvsFo",
    authDomain: "photobioreactor-ba2d0.firebaseapp.com",
    databaseURL: "https://photobioreactor-ba2d0-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "photobioreactor-ba2d0",
    storageBucket: "photobioreactor-ba2d0.firebasestorage.app",
    messagingSenderId: "338121363769",
    appId: "1:338121363769:web:ca6325c300a46668a8d8e8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Create chart helper
  function makeChart(ctx, label, color, yTitle) {
    return new Chart(ctx, {
      type: 'line',
      data: { datasets: label.map((l, i) => ({
        label: l,
        data: [],
        borderColor: color[i],
        fill: false,
        borderWidth: 1.5,
        pointRadius: 0
      })) },
      options: {
        responsive: true,
        interaction: { mode: 'x' },
        plugins: {
          zoom: {
            zoom: { wheel: { enabled: true }, mode: 'x' },
            pan: { enabled: true, mode: 'x' }
          },
          legend: { position: 'top' }
        },
        scales: {
          x: {
            type: 'time',
            time: { tooltipFormat: 'MMM d, h:mm:ss a', unit: 'minute' },
            title: { display: true, text: 'Time' }
          },
          y: {
            title: { display: true, text: yTitle }
          }
        }
      }
    });
  }

  const tempChart = makeChart(
    document.getElementById('tempChart').getContext('2d'),
    ['Temperature 1 (°C)', 'Temperature 2 (°C)', 'Temperature 3 (°C)'],
    ['blue', 'green', 'red'],
    'Temperature (°C)'
  );

  const phChart = makeChart(
    document.getElementById('phChart').getContext('2d'),
    ['pH'],
    ['purple'],
    'pH Value'
  );

  const ecChart = makeChart(
    document.getElementById('ecChart').getContext('2d'),
    ['EC'],
    ['orange'],
    'EC (mS/cm)'
  );

  const parChart = makeChart(
    document.getElementById('parChart').getContext('2d'),
    ['PAR'],
    ['limegreen'],
    'PAR (µmol/m²/s)'
  );

  const dataBuffer = [];

  // Fetch large historical window (e.g. last 5000 entries)
  db.ref('sensors/data').limitToLast(5000).on('child_added', snapshot => {
    const key = snapshot.key;
    const data = snapshot.val();

    const parts = key.split('_');
    const datetimeStr = `${parts[2]}T${parts[3].replace(/-/g, ':')}`;
    const timestamp = new Date(datetimeStr);

    const entry = {
      timestamp,
      temp1: parseFloat(data.temp1),
      temp2: parseFloat(data.temp2),
      temp3: parseFloat(data.temp3),
      ph: parseFloat(data.pHraw),
      ec: parseFloat(data.ecRaw),
      par: parseFloat(data.par)
    };

    dataBuffer.push(entry);
    updateCharts();
  });

  const filterSelect = document.getElementById('timeFilter');
  filterSelect.addEventListener('change', updateCharts);

  function updateCharts() {
    const filter = filterSelect.value;
    const now = new Date();
    let rangeStart, timeUnit;

    if (filter === '5m') {
      rangeStart = new Date(now - 5 * 60 * 1000);
      timeUnit = 'minute';
    } else if (filter === '1h') {
      rangeStart = new Date(now - 60 * 60 * 1000);
      timeUnit = 'minute';
    } else if (filter === '1d') {
      rangeStart = new Date(now - 24 * 60 * 60 * 1000);
      timeUnit = 'hour';
    } else if (filter === '1M') {
      rangeStart = new Date(now);
      rangeStart.setMonth(now.getMonth() - 1);
      timeUnit = 'day';
    }

    const filtered = dataBuffer.filter(d => d.timestamp >= rangeStart);

    tempChart.data.datasets[0].data = filtered.map(d => ({ x: d.timestamp, y: d.temp1 }));
    tempChart.data.datasets[1].data = filtered.map(d => ({ x: d.timestamp, y: d.temp2 }));
    tempChart.data.datasets[2].data = filtered.map(d => ({ x: d.timestamp, y: d.temp3 }));
    tempChart.options.scales.x.time.unit = timeUnit;
    tempChart.update('none');

    phChart.data.datasets[0].data = filtered.map(d => ({ x: d.timestamp, y: d.ph }));
    phChart.options.scales.x.time.unit = timeUnit;
    phChart.update('none');

    ecChart.data.datasets[0].data = filtered.map(d => ({ x: d.timestamp, y: d.ec }));
    ecChart.options.scales.x.time.unit = timeUnit;
    ecChart.update('none');

    parChart.data.datasets[0].data = filtered.map(d => ({ x: d.timestamp, y: d.par }));
    parChart.options.scales.x.time.unit = timeUnit;
    parChart.update('none');
  }

  // Add zoom reset button
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset Zoom';
  resetBtn.style.margin = '10px';
  resetBtn.onclick = () => {
    [tempChart, phChart, ecChart, parChart].forEach(ch => ch.resetZoom());
  };
  document.body.insertBefore(resetBtn, document.body.firstChild);
</script>

</body>
</html>
